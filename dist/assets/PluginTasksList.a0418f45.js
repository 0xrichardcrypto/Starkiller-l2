import{_ as x}from"./TooltipButton.01c96598.js";import{_ as v}from"./ListPageTop.dd85a4b7.js";import{h as b}from"./moment.9709ab41.js";import{l as P,_ as w}from"./index.8210e5b2.js";import{i as y,bj as u,o as g,bk as T,n as k,ab as h,a1 as I,ay as d,l as m,b as f,aB as S,c as l,j as C,k as o,V as r,a as D}from"./index.3392e392.js";import{D as $}from"./download-stager.85a6b476.js";import{a as O,b as U}from"./download-api.f398cae0.js";import{_ as A,a as p,b as c,c as _}from"./VExpansionPanelHeader.6f0f98fd.js";import{_ as F}from"./VDataTable.f2185226.js";import{_ as B}from"./VTooltip.991ee143.js";import{_ as G}from"./VSelect.e9728020.js";const j={name:"PluginTasksList",components:{TooltipButton:x,ListPageTop:v},mixins:[$],props:{plugin:{type:Object,required:!1,default:null},refreshTasks:{type:Boolean,default:!1},active:{type:Boolean,default:!1}},data(){return{breads:[{text:"Plugins",disabled:!0,href:"/plugins"},{text:"Tasks",disabled:!0,href:"/plugins?tab=tasks"}],currentPage:1,totalPages:1,totalItems:0,itemsPerPage:10,search:"",loading:!1,moment:b,sortBy:"id",sortDesc:!0,refreshInterval:null,expandedTasks:{},headers:[{text:"Task ID",value:"id",sortable:!0},{text:"Status",value:"status",sortable:!0},{text:"Plugin",value:"plugin_id",sortable:!0},{text:"Task Input",value:"input",sortable:!1},{text:"Task Name",value:"task_name",sortable:!1},{text:"User",value:"username",sortable:!1},{text:"Updated At",value:"updated_at",sortable:!0},{text:"Actions",value:"actions",sortable:!1}],selectedPlugins:[],selectedUsers:[]}},computed:{...y({plugins:t=>t.plugin.plugins,users:t=>t.user.users}),selectedAllPlugins:{set(t){t?this.selectedPlugins=this.plugins.map(e=>e.id):this.selectedPlugins=[],this.debouncedGetTasks()},get(){return this.selectedPlugins.length===this.plugins.length}},selectedAllUsers:{set(t){t?this.selectedUsers=this.users.map(e=>e.id):this.selectedUsers=[],this.debouncedGetTasks()},get(){return this.selectedUsers.length===this.users.length}}},watch:{refreshTasks(t){t?(this.debouncedGetTasks(),this.refreshInterval=setInterval(()=>{this.debouncedGetTasks()},8e3)):clearInterval(this.refreshInterval)},plugin:{handler(){this.initialize()}}},async mounted(){this.debouncedGetTasks=P(this.getTasks,500),await Promise.all([this.$store.dispatch("plugin/getPlugins"),this.$store.dispatch("user/getUsers")]),this.selectedPlugins=this.plugins.map(t=>t.id),this.selectedUsers=this.users.map(t=>t.id),this.plugin&&(this.selectedPlugins=[this.plugin.id]),this.initialize()},beforeDestroy(){clearInterval(this.refreshInterval)},methods:{initialize(){this.debouncedGetTasks()},truncateMessage(t){return t?t.length>30?`${t.substr(0,30)}...`:t:""},isDownload(t){return t.downloads&&t.downloads.length>0},downloadFile(t){O(t.id)},hasOutput(t){return!!t.output},async downloadInput(t){if(t.input){if(!this.expandedTasks[t.id]){const e=await u(t.plugin_id,t.id);this.expandedTasks[t.id]=e}this.downloadText(this.expandedTasks[t.id].full_input,`${t.plugin_id}-${t.id}-input.txt`)}},downloadOutput(t){t.output&&this.downloadText(t.output,`${t.plugin_id}-${t.id}-output.txt`)},async copyInput(t){if(t.input){if(!this.expandedTasks[t.id]){const e=await u(t.plugin_id,t.id);this.expandedTasks[t.id]=e}try{navigator.clipboard.writeText(this.expandedTasks[t.id].full_input)}catch{this.$snack.warn("Failed to copy to clipboard. You must be on HTTPS or localhost.")}}},copyOutput(t){if(t.output)try{navigator.clipboard.writeText(t.output)}catch{this.$snack.warn("Failed to copy to clipboard. You must be on HTTPS or localhost.")}},imageData(t,e){var n;const s=(n=this.expandedTasks[t.id])==null?void 0:n.downloads;if(s){const a=s.find(i=>i.id===e.id);if(a)return a.image}return null},async getImagesForTask(t){var e;if(!this.expandedTasks[t.id]){const s=await u(t.plugin_id,t.id);this.expandedTasks[t.id]=s}for(let s=0;s<t.downloads.length;s++){const n=t.downloads[s];if(!((e=this.expandedTasks[t.id].downloads[n.id])!=null&&e.image)&&n.filename.match(/[^/]+(jpg|jpeg|png|gif)$/)){const a=await U(n.id);this.expandedTasks[t.id].downloads[s].image=a}}g.set(this.tasks,this.tasks.indexOf(t),t)},async toggleSeeFullInput(t){if(this.expandedTasks[t.id])t.expandedInput=!t.expandedInput;else{const e=await u(t.plugin_id,t.id);this.expandedTasks[t.id]=e,t.expandedInput=!0}g.set(this.tasks,this.tasks.indexOf(t),t)},async getTasks(){if(this.selectedPlugins.length===0){this.tasks=[],this.currentPage=1,this.totalPages=1,this.totalItems=0;return}this.loading=!0;let t=null;this.selectedPlugins.length>0&&(t=this.selectedPlugins);const e=await T(t,{page:this.currentPage,limit:this.itemsPerPage,sortBy:this.sortBy,sortOrder:this.sortDesc?"desc":"asc",users:this.selectedUsers,search:this.search});this.currentPage=e.page,this.totalPages=e.total_pages,this.totalItems=e.total,this.tasks=e.records.map(s=>(s.uniqueId=`${s.plugin_id}-${s.id}`,this.expandedTasks[s.id]&&(s.expandedInput=!0),s)),this.tasks=e.records,this.loading=!1},handleSearch(){this.debouncedGetTasks()},handleFilterChange(){this.debouncedGetTasks()},handlePageChange(t){this.currentPage=t,this.debouncedGetTasks()},handleOptionsChange(t){this.currentPage=t.page,this.itemsPerPage=t.itemsPerPage,t.sortBy.length>0?(this.sortBy=t.sortBy[0],this.sortDesc=t.sortDesc[0]):(this.sortBy="id",this.sortDesc=!0),this.debouncedGetTasks()}}};var M=function(){var e=this,s=e._self._c;return s("div",[e.active?s(v,{attrs:{breads:e.breads,"show-create":!1,"show-refresh":!0,"show-delete":!1},on:{refresh:e.getTasks}}):e._e(),s("div",{staticStyle:{display:"flex","flix-direction":"row"}},[s(h,{staticClass:"mr-2 pa-2",staticStyle:{width:"300px"},attrs:{elevation:"2",outlined:""}},[s(A,{staticClass:"mb-6",attrs:{multiple:""}},[s(p,[s(c,{attrs:{"expand-icon":"mdi-menu-down"}},[e._v(" Search ")]),s(_,[s(I,{attrs:{label:"Search",outlined:"",dense:"",required:""},on:{input:e.handleSearch},model:{value:e.search,callback:function(n){e.search=n},expression:"search"}})],1)],1),e.plugin?e._e():s(p,[s(c,{attrs:{"expand-icon":"mdi-menu-down"}},[e._v(" Plugins ")]),s(_,[s(d,{attrs:{"x-small":"",dense:"",label:"Select All"},model:{value:e.selectedAllPlugins,callback:function(n){e.selectedAllPlugins=n},expression:"selectedAllPlugins"}}),s(m,{staticClass:"pb-4"}),e._l(e.plugins,function(n){return s(d,{key:n.id,attrs:{value:n.id,"x-small":"",dense:"",label:n.name},on:{change:e.handleFilterChange},model:{value:e.selectedPlugins,callback:function(a){e.selectedPlugins=a},expression:"selectedPlugins"}})})],2)],1),s(p,[s(c,{attrs:{"expand-icon":"mdi-menu-down"}},[e._v(" Users ")]),s(_,[s(d,{attrs:{"x-small":"",dense:"",label:"Select All"},model:{value:e.selectedAllUsers,callback:function(n){e.selectedAllUsers=n},expression:"selectedAllUsers"}}),s(m,{staticClass:"pb-4"}),e._l(e.users,function(n){return s(d,{key:n.id,attrs:{value:n.id,"x-small":"",dense:"",label:n.username},on:{change:e.handleFilterChange},model:{value:e.selectedUsers,callback:function(a){e.selectedUsers=a},expression:"selectedUsers"}})})],2)],1)],1)],1),s(h,{staticStyle:{"flex-grow":"1"},attrs:{elevation:"2",outlined:""}},[s(w,{attrs:{length:e.totalPages,"total-visible":10},on:{input:e.handlePageChange},model:{value:e.currentPage,callback:function(n){e.currentPage=n},expression:"currentPage"}}),s(F,{attrs:{headers:e.headers,items:e.tasks,"item-key":"uniqueId","sort-by":e.sortBy,"sort-desc":e.sortDesc,"server-items-length":e.totalItems,"footer-props":{"items-per-page-options":[10,25,50,100]},"items-per-page":e.itemsPerPage,loading:e.loading,page:e.currentPage,"show-expand":""},on:{"update:itemsPerPage":function(n){e.itemsPerPage=n},"update:items-per-page":function(n){e.itemsPerPage=n},"update:options":e.handleOptionsChange},scopedSlots:e._u([{key:"expanded-item",fn:function({headers:n,item:a}){return[s("td",{attrs:{colspan:n.length}},[s("div",[s("div",{staticClass:"pt-2"},[s(x,{attrs:{icon:a.expandedInput?"fa-minus":"fa-plus",text:"See Full Input","x-small":""},on:{click:function(i){return e.toggleSeeFullInput(a)}}})],1),s("p",[s("b",[e._v("Task Input:")])]),s("p",{staticClass:"mono",staticStyle:{"max-width":"900px"}},[e._v(" "+e._s(a.expandedInput?e.expandedTasks[a.id].full_input:a.input)+" ")]),s("p",[s("b",[e._v("Task Output:")])]),a.downloads.length>0&&a.downloads.some(i=>i.filename.match(/[^/]+(jpg|jpeg|png|gif)$/))?s("div",[s(f,{attrs:{text:"","x-small":""},on:{click:function(i){return e.getImagesForTask(a)}}},[e._v(" View Images ")]),s("div",e._l(a.downloads,function(i){return s(S,{key:i.id,attrs:{src:e.imageData(a,i),alt:i.filename,"max-width":700,contain:""}})}),1)],1):e._e(),s("p",{staticClass:"mono",staticStyle:{"max-width":"900px"}},[e._v(" "+e._s(a.output)+" ")])])])]}},{key:"item.status",fn:function({item:n}){return[e._v(" "+e._s(n.status)+" ")]}},{key:"item.input",fn:function({item:n}){return[s("span",[e._v(e._s(e.truncateMessage(n.input)))])]}},{key:"item.task_name",fn:function({item:n}){return[s("span",[e._v(e._s(n.module_name==null?n.task_name:n.module_name))])]}},{key:"item.updated_at",fn:function({item:n}){return[s(B,{attrs:{top:""},scopedSlots:e._u([{key:"activator",fn:function({on:a}){return[s("span",e._g({},a),[e._v(e._s(e.moment(n.updated_at).fromNow()))])]}}],null,!0)},[s("span",[e._v(e._s(e.moment(n.updated_at).format("MMM D YYYY, h:mm:ss a")))])])]}},{key:"item.actions",fn:function({item:n}){return[s(G,{attrs:{"offset-y":""},scopedSlots:e._u([{key:"activator",fn:function({on:a,attrs:i}){return[s(f,e._g(e._b({attrs:{text:"",icon:"","x-small":""}},"v-btn",i,!1),a),[s(l,[e._v("fa-ellipsis-v")])],1)]}}],null,!0)},[s(C,{staticClass:"ml-2 mr-2"},[s(o,{key:"downloadInput",attrs:{link:""},on:{click:function(a){return e.downloadInput(n)}}},[s(r,[s(l,[e._v("fa-download")]),e._v(" Download Input ")],1)],1),e.hasOutput(n)?s(o,{key:"downloadOutput",attrs:{link:""},on:{click:function(a){return e.downloadOutput(n)}}},[s(r,[s(l,[e._v("fa-download")]),e._v(" Download Output ")],1)],1):e._e(),s(o,{key:"clipboardInput",attrs:{link:""},on:{click:function(a){return e.copyInput(n)}}},[s(r,[s(l,[e._v("fa-paperclip")]),e._v(" Copy Input to Clipboard ")],1)],1),e.hasOutput(n)?s(o,{key:"clipboardOutput",attrs:{link:""},on:{click:function(a){return e.copyOutput(n)}}},[s(r,[s(l,[e._v("fa-paperclip")]),e._v(" Copy Output to Clipboard ")],1)],1):e._e(),s(D),e._l(n.downloads,function(a){return s(o,{key:"download-"+a.id,attrs:{link:""},on:{click:function(i){return e.downloadFile(a)}}},[s(r,[s(l,[e._v("fa-download")]),e._v(" Download "+e._s(a.filename)+" ")],1)],1)})],2)],1)]}}])})],1)],1)],1)},Y=[],q=k(j,M,Y,!1,null,null,null,null);const X=q.exports;export{X as _};
